<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡ç« å‘å¸ƒåŠ©æ‰‹</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary: #7c3aed;
            --primary-light: #a78bfa;
            --primary-dark: #5b21b6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-dark: #09090b;
            --bg-panel: #18181b;
            --bg-card: #27272a;
            --bg-hover: #3f3f46;
            --text: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #27272a;
            --border-light: #3f3f46;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
        }

        /* ==================== ä¸»å¸ƒå±€ ==================== */
        .app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦ä¾§é¢æ¿ - å¯¹è¯åŒº */
        .left-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            background: var(--bg-dark);
        }

        /* å³ä¾§é¢æ¿ - é¢„è§ˆåŒº */
        .right-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
        }

        /* ==================== é¡¶éƒ¨å¯¼èˆª ==================== */
        .panel-header {
            height: 60px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 600;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-card);
            color: var(--text);
        }

        .icon-btn.warning::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
        }

        /* ==================== ç”¨æˆ·å¤´åƒ/ç™»å½• ==================== */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .user-avatar:hover {
            border-color: var(--primary);
        }

        .login-btn {
            padding: 6px 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .login-btn:hover {
            background: var(--primary-dark);
        }

        .login-btn svg {
            width: 16px;
            height: 16px;
        }

        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .user-menu-email {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .user-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .user-menu-item:hover {
            background: var(--bg-hover);
        }

        .user-menu-item.danger {
            color: var(--error);
        }

        /* ==================== å¯¹è¯åŒºåŸŸ ==================== */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .chat-area::-webkit-scrollbar {
            width: 6px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.assistant {
            display: flex;
            gap: 12px;
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--primary), var(--accent));
        }

        .bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.6;
            font-size: 14px;
        }

        .message.assistant .bubble {
            background: var(--bg-card);
            border-top-left-radius: 4px;
        }

        .message.user .bubble {
            background: var(--primary);
            border-top-right-radius: 4px;
        }

        /* ==================== é€‰é¡¹å¡ç‰‡ ==================== */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .option-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .option-card:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .option-card:active {
            transform: scale(0.98);
        }

        .option-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .option-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .option-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ==================== è¾“å…¥åŒºåŸŸ ==================== */
        .input-area {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
        }

        .input-wrapper {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
        }

        .input-textarea {
            width: 100%;
            min-height: 100px;
            max-height: 300px;
            padding: 16px;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
        }

        .input-textarea:focus {
            outline: none;
        }

        .input-textarea::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-top: 1px solid var(--border);
        }

        .input-tools {
            display: flex;
            gap: 4px;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .submit-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .submit-btn:hover {
            background: var(--primary-light);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== å³ä¾§é¢„è§ˆåŒº ==================== */
        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-header .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .preview-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .preview-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
        }

        .preview-placeholder-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .preview-placeholder-text {
            font-size: 14px;
            max-width: 200px;
            line-height: 1.6;
        }

        .preview-content {
            background: white;
            color: #333;
            border-radius: 12px;
            padding: 24px;
            min-height: 400px;
        }

        /* ==================== è¿›åº¦æŒ‡ç¤ºå™¨ ==================== */
        .progress-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .progress-emoji {
            font-size: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        .progress-timer {
            font-size: 13px;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        .progress-bar-bg {
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* ==================== è®¾ç½®å¼¹çª— ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-panel);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text);
        }

        .btn-primary {
            background: var(--primary);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        /* ==================== å½•éŸ³æŒ‰é’® ==================== */
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .record-btn:hover {
            transform: scale(1.05);
        }

        .record-btn.recording {
            background: var(--error);
            animation: recording-pulse 1.5s infinite;
        }

        @keyframes recording-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
            }

            50% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }

        /* ==================== æ ·å¼é€‰æ‹© ==================== */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .style-card {
            aspect-ratio: 1;
            background: var(--bg-card);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 12px;
        }

        .style-card:hover {
            border-color: var(--primary);
        }

        .style-card.selected {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.2);
        }

        .style-card .icon {
            font-size: 24px;
        }

        /* ==================== è‡ªç”±å¯¹è¯è¾“å…¥æ¡† ==================== */
        .free-chat-input {
            padding: 16px 20px;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .free-chat-container {
            display: flex;
            gap: 10px;
            align-items: center;
            background: var(--bg-card);
            border-radius: 24px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            transition: border-color 0.2s;
        }

        .free-chat-container:focus-within {
            border-color: var(--primary);
        }

        .free-chat-container input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .free-chat-container input::placeholder {
            color: var(--text-muted);
        }

        .free-chat-send {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .free-chat-send:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* ==================== ç§»åŠ¨ç«¯é€‚é… ==================== */
        @media (max-width: 768px) {
            .app {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
                height: 100%;
                border-right: none;
            }

            .right-panel {
                display: none;
            }

            .right-panel.mobile-show {
                display: flex;
                position: fixed;
                inset: 0;
                width: 100%;
                z-index: 200;
            }

            .panel-header {
                height: 56px;
                padding: 0 16px;
            }

            .logo {
                font-size: 14px;
            }

            .logo-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .chat-area {
                padding: 16px;
            }

            .message {
                margin-bottom: 20px;
            }

            .message.assistant {
                gap: 10px;
            }

            .avatar {
                width: 32px;
                height: 32px;
                font-size: 16px;
                border-radius: 8px;
            }

            .bubble {
                max-width: 90%;
                padding: 12px 14px;
                border-radius: 14px;
                font-size: 14px;
                line-height: 1.5;
            }

            .options-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .option-card {
                padding: 14px;
                border-radius: 10px;
            }

            .option-icon {
                font-size: 24px;
                margin-bottom: 8px;
            }

            .option-title {
                font-size: 13px;
            }

            .option-desc {
                font-size: 11px;
            }

            .style-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .style-card {
                padding: 10px 6px;
                border-radius: 10px;
                font-size: 11px;
            }

            .style-card .icon {
                font-size: 20px;
            }

            .input-area {
                padding: 12px 16px 24px;
            }

            .input-wrapper {
                border-radius: 14px;
            }

            .input-textarea {
                min-height: 80px;
                padding: 14px;
                font-size: 15px;
            }

            .submit-btn {
                padding: 10px 16px;
                font-size: 13px;
                border-radius: 8px;
            }

            .tool-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            /* è¿›åº¦æ¡ */
            .progress-card {
                padding: 14px;
            }

            .progress-title {
                font-size: 13px;
            }

            .progress-emoji {
                font-size: 18px;
            }

            /* å½•éŸ³æŒ‰é’® */
            .record-btn {
                width: 70px;
                height: 70px;
                font-size: 28px;
            }

            /* å¼¹çª— */
            .modal {
                max-width: 100%;
                margin: 0;
                border-radius: 20px 20px 0 0;
                max-height: 85vh;
            }

            .modal-header {
                padding: 16px 20px;
            }

            .modal-body {
                padding: 20px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-input {
                padding: 12px;
                font-size: 14px;
            }
        }

        /* ==================== åº•éƒ¨å¼€å‘è€…ä¿¡æ¯ ==================== */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 8px;
            font-size: 11px;
            color: var(--text-muted);
            background: linear-gradient(to top, var(--bg-dark), transparent);
            pointer-events: none;
            z-index: 50;
        }

        .footer a {
            color: var(--text-muted);
            text-decoration: none;
            pointer-events: auto;
        }

        .footer a:hover {
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .footer {
                font-size: 10px;
                padding: 6px;
            }
        }

        /* ==================== éšè—å…ƒç´  ==================== */
        .hidden {
            display: none !important;
        }

        #file-input {
            display: none;
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <div class="panel-header">
                <div class="logo">
                    <div class="logo-icon">âœ¨</div>
                    <span>æ–‡ç« å‘å¸ƒåŠ©æ‰‹</span>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="openSettings()" title="è®¾ç½®" id="settings-btn">âš™ï¸</button>
                    <!-- ç™»å½•/ç”¨æˆ·åŒºåŸŸ -->
                    <div id="auth-area" style="position: relative; margin-left: 8px;">
                        <!-- æœªç™»å½•æ—¶æ˜¾ç¤ºç™»å½•æŒ‰é’® -->
                        <button class="login-btn" id="login-btn" onclick="showGoogleLogin()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                    fill="#4285F4" />
                                <path
                                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                    fill="#34A853" />
                                <path
                                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                    fill="#FBBC05" />
                                <path
                                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                    fill="#EA4335" />
                            </svg>
                            ç™»å½•
                        </button>
                        <!-- å·²ç™»å½•æ—¶æ˜¾ç¤ºå¤´åƒ -->
                        <div id="user-area" style="display: none;">
                            <img class="user-avatar" id="user-avatar" onclick="toggleUserMenu()" src="" alt="ç”¨æˆ·å¤´åƒ">
                            <div class="user-menu" id="user-menu">
                                <div class="user-menu-header">
                                    <div id="user-name">ç”¨æˆ·</div>
                                    <div class="user-menu-email" id="user-email">email@example.com</div>
                                </div>
                                <div class="user-menu-item" onclick="openSettings()">âš™ï¸ è®¾ç½®</div>
                                <div class="user-menu-item danger" onclick="handleLogout()">ğŸšª é€€å‡ºç™»å½•</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-area" id="chat-area">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message assistant">
                    <div class="avatar">ğŸ¤–</div>
                    <div class="bubble">
                        <div style="font-size: 16px; margin-bottom: 12px;">ğŸ‘‹ å—¨ï¼æˆ‘æ˜¯ä½ çš„å…¬ä¼—å·æ–‡ç« åŠ©æ‰‹</div>
                        <div style="color: var(--text-secondary); margin-bottom: 16px;">æˆ‘å¯ä»¥å¸®ä½ æŠŠä»»ä½•å†…å®¹å˜æˆç²¾ç¾çš„å…¬ä¼—å·æ–‡ç« ï¼Œé€‰æ‹©å¼€å§‹æ–¹å¼ï¼š
                        </div>

                        <div class="options-grid" id="start-options">
                            <div class="option-card" onclick="selectMode('markdown')">
                                <div class="option-icon">ğŸ“</div>
                                <div class="option-title">Markdown æ–‡ç« </div>
                                <div class="option-desc">å·²æœ‰æ ¼å¼åŒ–çš„å†…å®¹</div>
                            </div>
                            <div class="option-card" onclick="selectMode('text')">
                                <div class="option-icon">ğŸ’¬</div>
                                <div class="option-title">çº¯æ–‡å­—å†…å®¹</div>
                                <div class="option-desc">AI å¸®ä½ æ¶¦è‰²æˆæ–‡</div>
                            </div>
                            <div class="option-card" onclick="selectMode('voice')">
                                <div class="option-icon">ğŸ¤</div>
                                <div class="option-title">è¯­éŸ³è¾“å…¥</div>
                                <div class="option-desc">è¯´å‡ºæ¥ï¼ŒAI æ•´ç†</div>
                            </div>
                            <div class="option-card" onclick="selectMode('file')">
                                <div class="option-icon">ğŸ“</div>
                                <div class="option-title">ä¸Šä¼ æ–‡ä»¶</div>
                                <div class="option-desc">txtã€mdã€docx</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area" id="input-area" style="display: none;">
                <div class="input-wrapper">
                    <textarea class="input-textarea" id="content-input" placeholder="è¾“å…¥ä½ çš„å†…å®¹..."></textarea>
                    <div class="input-actions">
                        <div class="input-tools">
                            <button class="tool-btn" onclick="document.getElementById('file-input').click()"
                                title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>
                            <button class="tool-btn" onclick="pasteFromClipboard()" title="ç²˜è´´">ğŸ“‹</button>
                        </div>
                        <button class="submit-btn" onclick="submitContent()">
                            ç¡®è®¤ <span>â†’</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å¸¸æ€åŒ–è‡ªç”±å¯¹è¯è¾“å…¥æ¡† -->
            <div class="free-chat-input" id="free-chat-input">
                <div class="free-chat-container">
                    <input type="text" id="free-chat-text" placeholder="æœ‰ä»€ä¹ˆæƒ³è¡¥å……æˆ–ä¿®æ”¹çš„ï¼ŸæŒ‰ Enter å‘é€..."
                        onkeypress="if(event.key==='Enter') sendFreeChat()">
                    <button class="free-chat-send" onclick="sendFreeChat()" title="å‘é€">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ -->
        <div class="right-panel" id="right-panel">
            <div class="panel-header" style="justify-content: space-between;">
                <div class="preview-header">
                    <div class="dot"></div>
                    <span>å®æ—¶é¢„è§ˆ</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="icon-btn" id="edit-toggle-btn" onclick="toggleEditMode()" title="åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"
                        style="font-size: 12px; width: auto; padding: 6px 12px; gap: 4px; white-space: nowrap;">âœï¸
                        ç¼–è¾‘</button>
                    <button class="icon-btn mobile-only" onclick="closePreview()" style="display: none;">âœ•</button>
                </div>
            </div>

            <div class="preview-area" id="preview-area" contenteditable="false">
                <div class="preview-placeholder">
                    <div class="preview-placeholder-icon">ğŸ“„</div>
                    <div class="preview-placeholder-text">è¾“å…¥å†…å®¹å<br>è¿™é‡Œä¼šæ˜¾ç¤ºé¢„è§ˆ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼  -->
    <input type="file" id="file-input" accept=".txt,.md,.docx,.pdf" onchange="handleFileUpload(event)">

    <!-- è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">âš™ï¸ è®¾ç½®</div>
                <button class="modal-close" onclick="closeSettings()">âœ•</button>
            </div>
            <div class="modal-body">
                <!-- AI åˆ›ä½œ -->
                <div class="form-group">
                    <label class="form-label">DeepSeek API Key <span
                            style="color: var(--warning); font-size: 11px;">å¿…å¡«</span></label>
                    <input type="text" class="form-input" id="cfg-deepseek" placeholder="sk-...">
                    <div class="form-hint">ç”¨äº AI æ–‡ç« åˆ›ä½œãƒ»<a href="https://platform.deepseek.com/api_keys" target="_blank"
                            style="color: var(--primary-light);">è·å– Key â†’</a></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Groq API Key <span
                            style="color: var(--success); font-size: 11px;">å…è´¹</span></label>
                    <input type="text" class="form-input" id="cfg-groq" placeholder="gsk_...">
                    <div class="form-hint">è¯­éŸ³è½¬æ–‡å­—ãƒ»<a href="https://console.groq.com/keys" target="_blank"
                            style="color: var(--primary-light);">å…è´¹è·å– â†’</a></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Poe API Key</label>
                    <input type="text" class="form-input" id="cfg-poe" placeholder="Poe API Key">
                    <div class="form-hint">ç”¨äº AI ç”Ÿæˆå°é¢å›¾</div>
                </div>

                <div class="form-group">
                    <label class="form-label">ImgBB API Key</label>
                    <input type="text" class="form-input" id="cfg-imgbb" placeholder="å›¾åºŠ API Key">
                    <div class="form-hint">ç”¨äºä¸Šä¼ æ–‡ç« ä¸­çš„å›¾ç‰‡</div>
                </div>

                <!-- å…¬ä¼—å·é…ç½® -->
                <div
                    style="margin: 20px 0 12px; padding-top: 16px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-muted);">
                    å…¬ä¼—å·å‘å¸ƒ</div>

                <div class="form-group">
                    <label class="form-label">å¾®ä¿¡å…¬ä¼—å· AppID</label>
                    <input type="text" class="form-input" id="cfg-appid" placeholder="wx...">
                </div>
                <div class="form-group">
                    <label class="form-label">å¾®ä¿¡å…¬ä¼—å· AppSecret</label>
                    <input type="password" class="form-input" id="cfg-secret" placeholder="è¾“å…¥ AppSecret">
                </div>

                <!-- æœåŠ¡å™¨IPæ˜¾ç¤º -->
                <div class="form-group"
                    style="background: var(--bg-hover); border-radius: 8px; padding: 12px; margin-top: 12px;">
                    <label class="form-label" style="margin-bottom: 8px;">ğŸŒ æœåŠ¡å™¨ IPï¼ˆæ·»åŠ åˆ°å¾®ä¿¡ç™½åå•ï¼‰</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <code id="server-ip-display"
                            style="flex: 1; padding: 8px 12px; background: var(--bg-card); border-radius: 6px; font-family: monospace; color: var(--primary-light);">åŠ è½½ä¸­...</code>
                        <button class="btn btn-secondary" onclick="copyServerIP()"
                            style="padding: 8px 12px; white-space: nowrap;">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                    <div class="form-hint" style="margin-top: 8px;">
                        è¯·å°†æ­¤ IP æ·»åŠ åˆ°å…¬ä¼—å·åå° â†’ å¼€å‘ â†’ åŸºæœ¬é…ç½® â†’ IPç™½åå•
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== çŠ¶æ€ç®¡ç† ====================
        const state = {
            mode: null,
            rawContent: '',
            processedContent: '',
            htmlContent: '',
            title: '',
            summary: '',
            coverUrl: '',
            theme: 'professional',
            coverStyle: '',
            recordMode: 'web-speech',
            configured: false,
            user: null,  // ç”¨æˆ·ç™»å½•çŠ¶æ€
            pendingContent: ''  // ç”¨äºé‡è¯•
        };

        // Google Client ID
        const GOOGLE_CLIENT_ID = '918718013604-4uvqroc42ese3muoff0jkkpne6v3hkvq.apps.googleusercontent.com';

        // ç”¨æˆ·IDå­˜å‚¨é”®
        const USER_STORAGE_KEY = 'wechat_publisher_user';

        // é€šç”¨APIè¯·æ±‚å‡½æ•°ï¼ˆè‡ªåŠ¨å¸¦ä¸Šç”¨æˆ·IDï¼Œå¹¶æ£€æµ‹å“åº”ç±»å‹ï¼‰
        async function apiRequest(url, options = {}) {
            const user = state.user || JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || 'null');
            const headers = options.headers || {};

            if (user && user.id) {
                headers['X-User-Id'] = user.id;
            }

            const response = await fetch(url, {
                ...options,
                headers,
                credentials: 'include'
            });

            // æ£€æŸ¥å“åº”æ˜¯å¦ä¸º JSON
            const contentType = response.headers.get('content-type');
            if (!response.ok) {
                // å°è¯•è§£æé”™è¯¯å“åº”
                if (contentType && contentType.includes('application/json')) {
                    // JSON æ ¼å¼é”™è¯¯ï¼Œç»§ç»­è¿”å›è®©è°ƒç”¨æ–¹å¤„ç†
                    return response;
                } else {
                    // é JSON å“åº”ï¼ˆå¦‚ HTML é”™è¯¯é¡µé¢ï¼‰
                    const text = await response.text();
                    console.error('Non-JSON error response:', response.status, text.substring(0, 200));
                    throw new Error(`æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ (${response.status})ï¼Œè¯·ç¨åé‡è¯•`);
                }
            }

            return response;
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // å…ˆä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·çŠ¶æ€
            const savedUser = localStorage.getItem(USER_STORAGE_KEY);
            if (savedUser) {
                try {
                    state.user = JSON.parse(savedUser);
                    updateAuthUI(true);
                } catch (e) { }
            }

            await checkConfig();

            // ç§»åŠ¨ç«¯æ£€æµ‹
            if (window.innerWidth <= 768) {
                document.querySelector('.right-panel .icon-btn').style.display = 'block';
            }

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·èœå•
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('user-menu');
                const userAvatar = document.getElementById('user-avatar');
                if (userMenu && !userMenu.contains(e.target) && e.target !== userAvatar) {
                    userMenu.classList.remove('show');
                }
            });
        });

        // ==================== ç™»å½•ç›¸å…³ ====================
        async function checkAuthStatus() {
            try {
                const res = await fetch('/api/auth/status', { credentials: 'include' });
                const data = await res.json();

                if (data.logged_in) {
                    state.user = data.user;
                    updateAuthUI(true);
                } else {
                    updateAuthUI(false);
                }
            } catch (e) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', e);
                updateAuthUI(false);
            }
        }

        function updateAuthUI(loggedIn) {
            const loginBtn = document.getElementById('login-btn');
            const userArea = document.getElementById('user-area');

            if (loggedIn && state.user) {
                loginBtn.style.display = 'none';
                userArea.style.display = 'block';

                const avatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');
                const userEmail = document.getElementById('user-email');

                avatar.src = state.user.picture || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%237c3aed"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="40">' + (state.user.name?.[0] || 'U') + '</text></svg>';
                userName.textContent = state.user.name || 'ç”¨æˆ·';
                userEmail.textContent = state.user.email || '';
            } else {
                loginBtn.style.display = 'flex';
                userArea.style.display = 'none';
            }
        }

        function showGoogleLogin() {
            // åˆå§‹åŒ– Google Sign-In
            if (typeof google !== 'undefined' && google.accounts) {
                if (!GOOGLE_CLIENT_ID) {
                    alert('Google ç™»å½•æœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
                    return;
                }
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleCredential,
                    auto_select: false
                });
                google.accounts.id.prompt();
            } else {
                alert('Google ç™»å½•æœåŠ¡åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•...');
            }
        }

        async function handleGoogleCredential(response) {
            try {
                const res = await fetch('/api/auth/google', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ credential: response.credential })
                });

                const data = await res.json();

                if (data.success) {
                    state.user = data.user;
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(data.user));
                    updateAuthUI(true);

                    // é‡æ–°åŠ è½½é…ç½®
                    await checkConfig();

                    addMessage(`ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ${data.user.name}ï¼${data.user.has_config ? 'å·²åŠ è½½ä½ çš„é…ç½®ã€‚' : 'è¯·åœ¨è®¾ç½®ä¸­é…ç½® API Keyã€‚'}`);
                } else {
                    alert('ç™»å½•å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                console.error('ç™»å½•å¤±è´¥:', e);
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('show');
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                // æ¸…é™¤ Google ç™»å½•çŠ¶æ€
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.disableAutoSelect();
                }

                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem(USER_STORAGE_KEY);

                state.user = null;
                updateAuthUI(false);

                // å…³é—­èœå•
                document.getElementById('user-menu').classList.remove('show');

                addMessage('ğŸ‘‹ å·²é€€å‡ºç™»å½•');
            } catch (e) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', e);
            }
        }

        async function checkConfig() {
            try {
                const res = await apiRequest('/api/config');
                const data = await res.json();
                state.configured = data.configured;

                if (!state.configured) {
                    document.getElementById('settings-btn').classList.add('warning');
                    // é¦–æ¬¡ä½¿ç”¨æç¤º
                    if (!localStorage.getItem('config_prompted')) {
                        setTimeout(() => {
                            addMessage(`ğŸ’¡ <strong>é¦–æ¬¡ä½¿ç”¨æç¤º</strong><br><br>è¯·å…ˆç‚¹å‡»å³ä¸Šè§’ âš™ï¸ é…ç½® <strong>DeepSeek API Key</strong>ï¼Œæ‰èƒ½ä½¿ç”¨ AI åˆ›ä½œåŠŸèƒ½ã€‚<br><br><a href="https://platform.deepseek.com/api_keys" target="_blank" style="color: var(--primary-light);">ç‚¹å‡»è·å–å…è´¹ API Key â†’</a>`);
                            localStorage.setItem('config_prompted', '1');
                        }, 500);
                    }
                } else {
                    document.getElementById('settings-btn').classList.remove('warning');
                }
            } catch (e) {
                console.error('æ£€æŸ¥é…ç½®å¤±è´¥:', e);
            }
        }

        // ==================== æ¶ˆæ¯æ˜¾ç¤º ====================
        function addMessage(content, type = 'assistant') {
            const chatArea = document.getElementById('chat-area');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;

            if (type === 'assistant') {
                msg.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="bubble">${content}</div>
                `;
            } else {
                msg.innerHTML = `<div class="bubble">${content}</div>`;
            }

            chatArea.appendChild(msg);
            chatArea.scrollTop = chatArea.scrollHeight;
            return msg;
        }

        function addProgress(title, emoji = 'â³', seconds = 30) {
            const chatArea = document.getElementById('chat-area');
            const id = 'progress-' + Date.now();

            const msg = document.createElement('div');
            msg.className = 'message assistant';
            msg.innerHTML = `
                <div class="avatar">ğŸ¤–</div>
                <div class="bubble">
                    <div class="progress-card" id="${id}">
                        <div class="progress-header">
                            <div class="progress-title">
                                <span class="progress-emoji">${emoji}</span>
                                <span class="progress-text">${title}</span>
                            </div>
                            <div class="progress-timer">${seconds}s</div>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;

            chatArea.appendChild(msg);
            chatArea.scrollTop = chatArea.scrollHeight;

            let remaining = seconds;
            const interval = setInterval(() => {
                remaining--;
                const el = document.getElementById(id);
                if (!el) { clearInterval(interval); return; }

                el.querySelector('.progress-timer').textContent = remaining + 's';
                el.querySelector('.progress-bar').style.width = Math.min(95, ((seconds - remaining) / seconds) * 100) + '%';

                if (remaining <= 0) clearInterval(interval);
            }, 1000);

            return {
                id,
                element: msg,
                interval,
                complete: (text) => {
                    clearInterval(interval);
                    const el = document.getElementById(id);
                    if (el) {
                        el.querySelector('.progress-emoji').textContent = 'âœ…';
                        el.querySelector('.progress-text').textContent = text || 'å®Œæˆï¼';
                        el.querySelector('.progress-timer').textContent = '';
                        el.querySelector('.progress-bar').style.width = '100%';
                    }
                },
                remove: () => {
                    clearInterval(interval);
                    msg.remove();
                }
            };
        }

        // ==================== æ¨¡å¼é€‰æ‹© ====================
        function selectMode(mode) {
            // æ£€æŸ¥ç™»å½•å’Œé…ç½®çŠ¶æ€
            if (!checkAuthAndConfig()) {
                return;
            }

            state.mode = mode;

            // éšè—é€‰é¡¹
            document.getElementById('start-options').style.display = 'none';

            // æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©
            const modeNames = {
                markdown: 'ğŸ“ Markdown æ–‡ç« ',
                text: 'ğŸ’¬ çº¯æ–‡å­—å†…å®¹',
                voice: 'ğŸ¤ è¯­éŸ³è¾“å…¥',
                file: 'ğŸ“ ä¸Šä¼ æ–‡ä»¶'
            };
            addMessage(modeNames[mode], 'user');

            setTimeout(() => {
                switch (mode) {
                    case 'markdown':
                    case 'text':
                        showTextInput(mode);
                        break;
                    case 'voice':
                        showVoiceInput();
                        break;
                    case 'file':
                        showFileUpload();
                        break;
                }
            }, 300);
        }

        function showFileUpload() {
            addMessage(`å¥½çš„ï¼Œè¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼š
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">æ”¯æŒ .txtã€.mdã€.docxã€.pdf æ ¼å¼</div>
            `);

            // æ˜¾ç¤ºä¸Šä¼ ç•Œé¢
            setTimeout(() => {
                const chatArea = document.getElementById('chat-area');
                const uploadUI = document.createElement('div');
                uploadUI.className = 'message assistant';
                uploadUI.id = 'upload-ui';
                uploadUI.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="bubble" style="width: 100%; max-width: 400px;">
                        <div 
                            id="drop-zone"
                            onclick="document.getElementById('file-input').click()"
                            style="
                                border: 2px dashed var(--border-light);
                                border-radius: 12px;
                                padding: 32px 20px;
                                text-align: center;
                                cursor: pointer;
                                transition: all 0.2s;
                            "
                            onmouseover="this.style.borderColor='var(--primary)'; this.style.background='rgba(124,58,237,0.05)';"
                            onmouseout="this.style.borderColor='var(--border-light)'; this.style.background='transparent';"
                        >
                            <div style="font-size: 40px; margin-bottom: 12px;">ğŸ“</div>
                            <div style="font-weight: 500; margin-bottom: 6px;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                            <div style="font-size: 12px; color: var(--text-muted);">æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                        </div>
                        <div style="text-align: center; margin-top: 12px; font-size: 12px; color: var(--text-muted);">
                            æ”¯æŒ txtã€mdã€docxã€pdf
                        </div>
                    </div>
                `;
                chatArea.appendChild(uploadUI);
                chatArea.scrollTop = chatArea.scrollHeight;

                // æ·»åŠ æ‹–æ‹½æ”¯æŒ
                const dropZone = document.getElementById('drop-zone');
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--primary)';
                    dropZone.style.background = 'rgba(124,58,237,0.1)';
                });
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--border-light)';
                    dropZone.style.background = 'transparent';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--border-light)';
                    dropZone.style.background = 'transparent';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleDroppedFile(files[0]);
                    }
                });
            }, 300);
        }

        function handleDroppedFile(file) {
            // åˆ›å»ºä¸€ä¸ªå‡çš„ event å¯¹è±¡
            const fakeEvent = { target: { files: [file], value: '' } };
            handleFileUpload(fakeEvent);
        }

        function showTextInput(mode) {
            const placeholder = mode === 'markdown'
                ? 'ç²˜è´´ä½ çš„ Markdown å†…å®¹...\n\n# æ ‡é¢˜\n\næ­£æ–‡å†…å®¹...'
                : 'è¾“å…¥ä½ æƒ³è¡¨è¾¾çš„å†…å®¹ï¼ŒAI ä¼šå¸®ä½ æ•´ç†æˆæ–‡ç« ...';

            addMessage(`å¥½çš„ï¼è¯·${mode === 'markdown' ? 'ç²˜è´´ä½ çš„ Markdown å†…å®¹' : 'è¾“å…¥ä½ æƒ³è¡¨è¾¾çš„å†…å®¹'}ï¼š`);

            document.getElementById('input-area').style.display = 'block';
            document.getElementById('content-input').placeholder = placeholder;
            document.getElementById('content-input').focus();
        }

        // ==================== è¯­éŸ³è¾“å…¥ ====================
        function showVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const webSpeechSupported = !!SpeechRecognition;

            const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
            const isEdge = /Edg/.test(navigator.userAgent);

            state.recordMode = (webSpeechSupported && (isChrome || isEdge)) ? 'web-speech' : 'whisper';

            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            let modeText = '';

            if (state.recordMode === 'web-speech') {
                modeText = 'âœ… æ”¯æŒå®æ—¶è¯­éŸ³è¯†åˆ«ï¼Œè¾¹è¯´è¾¹è½¬æ–‡å­—';
            } else if (isIOS) {
                modeText = 'ğŸ“± iOSè®¾å¤‡ï¼šç‚¹å‡»å½•éŸ³æˆ–ç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥æ–‡å­—';
            } else {
                modeText = 'ğŸ™ï¸ å½•éŸ³æ¨¡å¼ï¼šå½•å®Œå AI è¯†åˆ«ï¼Œä¹Ÿå¯ç›´æ¥è¾“å…¥æ–‡å­—';
            }

            addMessage(`å¥½çš„ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®å¼€å§‹è¯´è¯ï¼š
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">${modeText}</div>
            `);

            // æ˜¾ç¤ºè¯­éŸ³è¾“å…¥ç•Œé¢
            setTimeout(() => {
                const chatArea = document.getElementById('chat-area');
                const voiceUI = document.createElement('div');
                voiceUI.className = 'message assistant';
                voiceUI.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="bubble" style="width: 100%; max-width: 400px;">
                        <div style="display: flex; align-items: center; gap: 16px; padding: 8px 0;">
                            <button class="record-btn" id="record-btn" onclick="toggleVoiceRecording()" style="width: 56px; height: 56px; font-size: 24px; flex-shrink: 0;">ğŸ¤</button>
                            <div style="flex: 1;">
                                <div id="record-status" style="font-size: 14px; font-weight: 500;">ç‚¹å‡»å¼€å§‹è¯´è¯</div>
                                <div id="record-timer" style="font-size: 20px; font-weight: 600; color: var(--primary-light); display: none;">00:00</div>
                            </div>
                        </div>
                        <textarea class="input-textarea" id="voice-text" placeholder="è¯†åˆ«ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œè¾“å…¥æˆ–ç¼–è¾‘..." style="background: var(--bg-hover); border-radius: 10px; min-height: 80px; margin-top: 12px; font-size: 14px;"></textarea>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <button class="tool-btn" onclick="clearVoiceText()" title="æ¸…ç©º">ğŸ—‘ï¸</button>
                            <button class="submit-btn" onclick="submitVoiceContent()">ç¡®è®¤å†…å®¹ â†’</button>
                        </div>
                    </div>
                `;
                chatArea.appendChild(voiceUI);
                chatArea.scrollTop = chatArea.scrollHeight;
            }, 300);
        }

        // è¯­éŸ³è¯†åˆ«ç›¸å…³å˜é‡
        let speechRecognition = null;
        let isRecognizing = false;
        let recognitionTimer = null;
        let recognitionSeconds = 0;
        let finalTranscript = '';

        // å½•éŸ³ç›¸å…³å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStream = null;

        function toggleVoiceRecording() {
            if (state.recordMode === 'web-speech') {
                toggleSpeechRecognition();
            } else {
                toggleWhisperRecording();
            }
        }

        function toggleSpeechRecognition() {
            if (isRecognizing) {
                stopSpeechRecognition();
            } else {
                startSpeechRecognition();
            }
        }

        function startSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                return;
            }

            if (!speechRecognition) {
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = true;
                speechRecognition.interimResults = true;
                speechRecognition.lang = 'zh-CN';

                speechRecognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    const textArea = document.getElementById('voice-text');
                    if (textArea) textArea.value = finalTranscript + interimTranscript;
                };

                speechRecognition.onerror = (e) => {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', e.error);
                    stopSpeechRecognition();
                };

                speechRecognition.onend = () => {
                    if (isRecognizing) {
                        try { speechRecognition.start(); } catch (e) { stopSpeechRecognition(); }
                    }
                };
            }

            try {
                speechRecognition.start();
                isRecognizing = true;
                recognitionSeconds = 0;
                finalTranscript = document.getElementById('voice-text')?.value || '';

                const btn = document.getElementById('record-btn');
                const status = document.getElementById('record-status');
                const timer = document.getElementById('record-timer');

                if (btn) { btn.classList.add('recording'); btn.textContent = 'â¹ï¸'; }
                if (status) status.textContent = 'æ­£åœ¨å¬...';
                if (timer) timer.style.display = 'block';

                recognitionTimer = setInterval(() => {
                    recognitionSeconds++;
                    const mins = Math.floor(recognitionSeconds / 60).toString().padStart(2, '0');
                    const secs = (recognitionSeconds % 60).toString().padStart(2, '0');
                    if (timer) timer.textContent = `${mins}:${secs}`;
                }, 1000);
            } catch (e) {
                alert('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥');
            }
        }

        function stopSpeechRecognition() {
            isRecognizing = false;
            if (speechRecognition) try { speechRecognition.stop(); } catch (e) { }
            if (recognitionTimer) { clearInterval(recognitionTimer); recognitionTimer = null; }

            const btn = document.getElementById('record-btn');
            const status = document.getElementById('record-status');

            if (btn) { btn.classList.remove('recording'); btn.textContent = 'ğŸ¤'; }
            if (status) status.textContent = 'ç‚¹å‡»å¼€å§‹è¯´è¯';
        }

        async function toggleWhisperRecording() {
            const btn = document.getElementById('record-btn');
            const status = document.getElementById('record-status');
            const timer = document.getElementById('record-timer');

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    recordingStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    // æ£€æµ‹æ”¯æŒçš„éŸ³é¢‘æ ¼å¼ï¼ˆSafariä¸æ”¯æŒwebmï¼‰
                    let mimeType = 'audio/webm';
                    let fileExt = 'webm';

                    if (MediaRecorder.isTypeSupported('audio/webm')) {
                        mimeType = 'audio/webm';
                        fileExt = 'webm';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                        fileExt = 'm4a';
                    } else if (MediaRecorder.isTypeSupported('audio/wav')) {
                        mimeType = 'audio/wav';
                        fileExt = 'wav';
                    } else {
                        // ä¸æŒ‡å®šç±»å‹ï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨é€‰æ‹©
                        mimeType = '';
                        fileExt = 'audio';
                    }

                    const recorderOptions = mimeType ? { mimeType } : {};
                    mediaRecorder = new MediaRecorder(recordingStream, recorderOptions);
                    audioChunks = [];
                    recognitionSeconds = 0;

                    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                    mediaRecorder.onstop = async () => {
                        recordingStream.getTracks().forEach(t => t.stop());
                        clearInterval(recognitionTimer);

                        const actualMimeType = mediaRecorder.mimeType || mimeType || 'audio/webm';
                        const audioBlob = new Blob(audioChunks, { type: actualMimeType });
                        status.textContent = 'è¯†åˆ«ä¸­...';

                        const formData = new FormData();
                        formData.append('audio', audioBlob, `recording.${fileExt}`);

                        try {
                            const user = state.user || JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || 'null');
                            const headers = {};
                            if (user && user.id) headers['X-User-Id'] = user.id;

                            const res = await fetch('/api/speech-to-text', {
                                method: 'POST',
                                body: formData,
                                headers,
                                credentials: 'include'
                            });
                            const data = await res.json();
                            if (data.success && data.text) {
                                document.getElementById('voice-text').value += data.text;
                                status.textContent = 'è¯†åˆ«å®Œæˆ';
                            } else {
                                // æœåŠ¡ç«¯è¯†åˆ«å¤±è´¥ï¼Œå°è¯•æç¤ºç”¨æˆ·
                                status.textContent = 'æœåŠ¡ç«¯è¯†åˆ«å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                                console.error('Speech-to-text failed:', data);
                                // å¦‚æœæ”¯æŒ Web Speech APIï¼Œæç¤ºå¯ä»¥åˆ‡æ¢
                                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                                if (SpeechRecognition) {
                                    status.innerHTML = 'æœåŠ¡ç«¯è¯†åˆ«å¤±è´¥ <a href="#" onclick="switchToWebSpeech();return false;" style="color:var(--primary-light);">ç‚¹å‡»åˆ‡æ¢åˆ°å®æ—¶è¯­éŸ³</a>';
                                }
                            }
                        } catch (e) {
                            status.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
                            console.error('Speech-to-text error:', e);
                        }
                    };

                    mediaRecorder.start(1000);
                    btn.classList.add('recording');
                    btn.textContent = 'â¹ï¸';
                    status.textContent = 'å½•éŸ³ä¸­...';
                    timer.style.display = 'block';

                    recognitionTimer = setInterval(() => {
                        recognitionSeconds++;
                        const mins = Math.floor(recognitionSeconds / 60).toString().padStart(2, '0');
                        const secs = (recognitionSeconds % 60).toString().padStart(2, '0');
                        timer.textContent = `${mins}:${secs}`;
                    }, 1000);
                } catch (e) {
                    // iOS Safariå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½è·å–éº¦å…‹é£
                    if (e.name === 'NotAllowedError') {
                        alert('è¯·å…è®¸è®¿é—®éº¦å…‹é£æƒé™ã€‚åœ¨iOSä¸Šï¼Œè¯·ç¡®ä¿åœ¨Safariè®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™è®¿é—®éº¦å…‹é£ã€‚');
                    } else {
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + e.message + '\n\næç¤ºï¼šæ‚¨å¯ä»¥ç›´æ¥åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­è¾“å…¥å†…å®¹ã€‚');
                    }
                }
            } else {
                mediaRecorder.stop();
                btn.classList.remove('recording');
                btn.textContent = 'ğŸ¤';
            }
        }

        function switchToWebSpeech() {
            // åˆ‡æ¢åˆ° Web Speech API æ¨¡å¼
            state.recordMode = 'web-speech';
            const status = document.getElementById('record-status');
            status.textContent = 'å·²åˆ‡æ¢åˆ°å®æ—¶è¯­éŸ³ï¼Œç‚¹å‡»éº¦å…‹é£å¼€å§‹';
            addMessage('ğŸ’¡ å·²åˆ‡æ¢åˆ°æµè§ˆå™¨å®æ—¶è¯­éŸ³è¯†åˆ«æ¨¡å¼ï¼Œæ”¯æŒè¾¹è¯´è¾¹è½¬æ–‡å­—');
        }

        function clearVoiceText() {
            const textArea = document.getElementById('voice-text');
            if (textArea) { textArea.value = ''; finalTranscript = ''; }
        }

        function submitVoiceContent() {
            const text = document.getElementById('voice-text')?.value?.trim();
            if (!text) { alert('è¯·å…ˆè¯´ç‚¹ä»€ä¹ˆ'); return; }
            state.rawContent = text;
            state.mode = 'voice';
            processWithAI(text);
        }

        // ==================== æ–‡ä»¶ä¸Šä¼  ====================
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ç§»é™¤ä¸Šä¼  UI
            const uploadUI = document.getElementById('upload-ui');
            if (uploadUI) uploadUI.remove();

            // æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶
            addMessage(`ğŸ“ ${file.name}`, 'user');

            const progress = addProgress('æ­£åœ¨è¯»å–æ–‡ä»¶...', 'ğŸ“„', 10);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const user = state.user || JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || 'null');
                const headers = {};
                if (user && user.id) headers['X-User-Id'] = user.id;

                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                    headers
                });

                const data = await res.json();
                progress.complete('æ–‡ä»¶è¯»å–å®Œæˆ');

                if (data.success) {
                    state.rawContent = data.content;
                    state.mode = 'file';

                    // æ˜¾ç¤ºæ–‡ä»¶å†…å®¹é¢„è§ˆ
                    const preview = data.content.length > 200
                        ? data.content.substring(0, 200) + '...'
                        : data.content;

                    addMessage(`å·²è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆ${data.content.length} å­—ï¼‰ï¼š
                        <div style="background: var(--bg-hover); border-radius: 8px; padding: 12px; margin-top: 10px; font-size: 13px; color: var(--text-secondary); max-height: 150px; overflow: hidden;">
                            ${preview.replace(/\n/g, '<br>')}
                        </div>
                    `);

                    // ã€ä¿®å¤ã€‘å…ˆè¯¢é—®å†™ä½œé£æ ¼ï¼Œå†ç”Ÿæˆ
                    setTimeout(() => {
                        showStyleSelection(data.content);
                    }, 800);
                } else {
                    addMessage(`âŒ ${data.error}`);
                }
            } catch (e) {
                progress.complete('è¯»å–å¤±è´¥');
                addMessage('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }

            // é‡ç½® input
            if (event.target.value) event.target.value = '';
        }

        // ==================== å†…å®¹å¤„ç† ====================
        async function submitContent() {
            const input = document.getElementById('content-input');
            const content = input?.value?.trim();

            if (!content) { alert('è¯·è¾“å…¥å†…å®¹'); return; }

            state.rawContent = content;
            document.getElementById('input-area').style.display = 'none';

            addMessage(content.length > 100 ? content.substring(0, 100) + '...' : content, 'user');

            // ã€æ–°å¢ã€‘å…ˆè¯¢é—®å†™ä½œé£æ ¼ï¼Œå†ç”Ÿæˆ
            showStyleSelection(content);
        }

        // é£æ ¼é€‰æ‹©
        function showStyleSelection(content) {
            addMessage(`
                <div style="margin-bottom: 12px;">ğŸ“ <strong>é€‰æ‹©å†™ä½œé£æ ¼</strong></div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                    <button class="style-option" onclick="selectStyle('professional', '${encodeURIComponent(content)}')" 
                        style="padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                        ğŸ’¼ ä¸“ä¸šæ·±åº¦
                    </button>
                    <button class="style-option" onclick="selectStyle('casual', '${encodeURIComponent(content)}')"
                        style="padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                        ğŸ˜Š è½»æ¾æ´»æ³¼
                    </button>
                    <button class="style-option" onclick="selectStyle('story', '${encodeURIComponent(content)}')"
                        style="padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                        ğŸ“– æ•…äº‹å™è¿°
                    </button>
                    <button class="style-option" onclick="selectStyle('simple', '${encodeURIComponent(content)}')"
                        style="padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                        âœ¨ ç®€æ´ç²¾ç‚¼
                    </button>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="custom-style-input" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰é£æ ¼è¦æ±‚..." 
                        style="flex: 1; padding: 10px 14px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text); outline: none;">
                    <button onclick="selectStyle('custom', '${encodeURIComponent(content)}')" 
                        style="padding: 10px 20px; border-radius: 20px; background: var(--primary); color: white; border: none; cursor: pointer;">
                        å¼€å§‹åˆ›ä½œ
                    </button>
                </div>
            `);
            state.pendingContent = content;
        }

        // é€‰æ‹©é£æ ¼åå¼€å§‹ç”Ÿæˆ
        async function selectStyle(style, encodedContent) {
            const content = decodeURIComponent(encodedContent);
            let styleHint = '';

            switch (style) {
                case 'professional':
                    styleHint = 'è¯·ç”¨ä¸“ä¸šã€ä¸¥è°¨çš„è¯­è¨€é£æ ¼ï¼Œé€‚åˆå•†åŠ¡æˆ–æŠ€æœ¯ç±»æ–‡ç« ';
                    break;
                case 'casual':
                    styleHint = 'è¯·ç”¨è½»æ¾ã€æ´»æ³¼çš„è¯­è¨€é£æ ¼ï¼Œåƒæœ‹å‹èŠå¤©ä¸€æ ·';
                    break;
                case 'story':
                    styleHint = 'è¯·ç”¨æ•…äº‹å™è¿°çš„æ–¹å¼ï¼Œæœ‰æƒ…èŠ‚ã€æœ‰ç”»é¢æ„Ÿ';
                    break;
                case 'simple':
                    styleHint = 'è¯·ç”¨ç®€æ´ç²¾ç‚¼çš„è¯­è¨€ï¼Œè¨€ç®€æ„èµ…';
                    break;
                case 'custom':
                    const customInput = document.getElementById('custom-style-input');
                    styleHint = customInput ? customInput.value : '';
                    if (!styleHint) {
                        styleHint = 'æŒ‰ç…§å†…å®¹æœ¬èº«æœ€é€‚åˆçš„é£æ ¼æ¥å†™';
                    }
                    break;
            }

            addMessage(`å·²é€‰æ‹©é£æ ¼ï¼š${styleHint}`, 'user');
            await processWithAI(content, styleHint);
        }

        async function processWithAI(content, styleHint = '') {
            addMessage('æ”¶åˆ°ï¼è®©æˆ‘å¸®ä½ æ•´ç†æˆå®Œæ•´æ–‡ç« ...');
            const progress = addProgress('AI æ­£åœ¨åˆ›ä½œå®Œæ•´æ–‡ç« ...', 'âœï¸', 90);

            try {
                // é¦–å…ˆè·å–ç”¨æˆ·çš„ API Key å’Œ åŠ¨æ€ Prompts
                const [configRes, promptRes] = await Promise.all([
                    apiRequest('/api/config/keys'),
                    apiRequest('/api/config/prompts')
                ]);
                const configData = await configRes.json();
                const promptData = await promptRes.json();

                if (!configData.deepseek_api_key) {
                    throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® DeepSeek API Key');
                }

                // ç›´æ¥åœ¨æµè§ˆå™¨è°ƒç”¨ DeepSeek APIï¼ˆå‡è½»æœåŠ¡å™¨å‹åŠ›ï¼‰
                const article = await callDeepSeekFromBrowser(
                    content,
                    configData.deepseek_api_key,
                    progress,
                    styleHint,
                    promptData // ä¼ å…¥åŠ¨æ€æç¤ºè¯
                );

                progress.complete('æ–‡ç« åˆ›ä½œå®Œæˆ');

                const word_count = article.replace(/\s/g, '').length;
                state.processedContent = article;

                // å°†æ–‡ç« æ˜¾ç¤ºåˆ°é¢„è§ˆåŒº
                updatePreview(article);

                addMessage(`âœ… æ–‡ç« å·²å®Œå–„ï¼ˆ${word_count} å­—ï¼‰`);
                setTimeout(() => showContentConfirm(article), 500);

            } catch (e) {
                progress.complete('å¤„ç†å¤±è´¥');
                const errorMsg = e.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                showRetryOption(errorMsg, content);
                console.error('Rewrite error:', e);
            }
        }

        // ç›´æ¥ä»æµè§ˆå™¨è°ƒç”¨ DeepSeek APIï¼ˆæ”¯æŒæµå¼è¾“å‡ºï¼Œä½¿ç”¨ç®€åŒ– Prompt ç³»ç»Ÿï¼‰
        async function callDeepSeekFromBrowser(content, apiKey, progress, styleHint = '', promptConfig = {}) {

            // ä½¿ç”¨åŠ¨æ€æ‹‰å–çš„æ–‡ç«  Promptï¼Œæ”¯æŒ {content} å’Œ {style} å ä½ç¬¦
            const defaultPrompt = `## Role: èµ„æ·±å¾®ä¿¡å…¬ä¼—å·çˆ†æ¬¾å†™æ‰‹ (æç»§åˆšé£æ ¼ 1.0)\n\n## Content:\nè¯·åŸºäºä»¥ä¸‹å†…å®¹è¿›è¡Œåˆ›ä½œï¼š\n---\n{content}\n---\n\n## Style: {style}`;
            let systemPrompt = promptConfig.article_prompt || defaultPrompt;

            const finalStyle = styleHint || 'ä¸“ä¸šã€æœ‰æ·±åº¦ã€å¼•äººå…¥èƒœ';

            // æ›¿æ¢å ä½ç¬¦
            systemPrompt = systemPrompt
                .replace('{content}', content)
                .replace('{style}', finalStyle);

            progress.update && progress.update('æ­£åœ¨è¿æ¥ DeepSeek...');

            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        { role: 'user', content: systemPrompt } // æ³¨æ„ï¼šæç»§åˆšé£æ ¼é€šå¸¸å»ºè®®ç›´æ¥æ”¾åœ¨ user ä¸­ä»¥è·å¾—æ›´å¥½éµä»æ€§ï¼Œæˆ–è€… system
                    ],
                    max_tokens: 8000,
                    temperature: 0.75,
                    stream: true
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('DeepSeek API error:', errorText);
                throw new Error('DeepSeek API è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®');
            }

            // å¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let fullContent = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const data = JSON.parse(line.substring(6));
                            const delta = data.choices[0].delta.content || '';
                            fullContent += delta;
                            // å®æ—¶åˆ·æ–°é¢„è§ˆ
                            updatePreview(fullContent);
                        } catch (e) {
                            // å¿½ç•¥éƒ¨åˆ†è§£æé”™è¯¯
                        }
                    }
                }
            }

            return fullContent.trim();
        }

        // æ›´æ–°é¢„è§ˆåŒºï¼ˆæµå¼è¾“å‡ºæ—¶å®æ—¶æ¸²æŸ“ Markdownï¼‰
        function updatePreview(content) {
            const previewArea = document.getElementById('preview-area');
            if (previewArea) {
                // æ›´å®Œå–„çš„ Markdown åˆ° HTML è½¬æ¢
                let html = content
                    // ä»£ç å—
                    .replace(/```([\s\S]*?)```/g, '<pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0;"><code>$1</code></pre>')
                    // è¡Œå†…ä»£ç 
                    .replace(/`([^`]+)`/g, '<code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px;">$1</code>')
                    // æ ‡é¢˜
                    .replace(/^### (.*$)/gim, '<h3 style="font-size: 18px; margin: 20px 0 12px; color: var(--primary-light);">$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2 style="font-size: 22px; margin: 24px 0 14px; color: var(--primary);">$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1 style="font-size: 28px; margin: 0 0 20px; color: var(--text); font-weight: 700;">$1</h1>')
                    // åŠ ç²—å’Œæ–œä½“
                    .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text);">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    // å¼•ç”¨
                    .replace(/^> (.*$)/gim, '<blockquote style="border-left: 3px solid var(--primary); padding-left: 16px; margin: 12px 0; color: var(--text-secondary);">$1</blockquote>')
                    // æ— åºåˆ—è¡¨
                    .replace(/^- (.*$)/gim, '<li style="margin: 6px 0; padding-left: 8px;">$1</li>')
                    .replace(/^\* (.*$)/gim, '<li style="margin: 6px 0; padding-left: 8px;">$1</li>')
                    // æœ‰åºåˆ—è¡¨
                    .replace(/^\d+\. (.*$)/gim, '<li style="margin: 6px 0; padding-left: 8px;">$1</li>')
                    // åˆ†å‰²çº¿
                    .replace(/^---$/gim, '<hr style="border: none; height: 1px; background: var(--border); margin: 24px 0;">')
                    // æ¢è¡Œ
                    .replace(/\n\n/g, '</p><p style="margin: 14px 0; line-height: 1.8;">')
                    .replace(/\n/g, '<br>');

                // åŒ…è£¹æ®µè½
                html = '<p style="margin: 14px 0; line-height: 1.8;">' + html + '</p>';

                previewArea.innerHTML = `<div style="padding: 20px; font-size: 16px; color: var(--text);">${html}</div>`;

                // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæµå¼è¾“å‡ºæ—¶ï¼‰
                previewArea.scrollTop = previewArea.scrollHeight;
            }
        }

        function showRetryOption(errorMsg, content) {
            addMessage(`
                <div style="margin-bottom: 12px;">âŒ ${errorMsg}</div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="openSettings()">
                        âš™ï¸ æ£€æŸ¥é…ç½®
                    </button>
                    <button class="submit-btn" style="flex: 1; justify-content: center;" onclick="retryProcess()">
                        ğŸ”„ é‡è¯•
                    </button>
                </div>
            `);
            // ä¿å­˜å†…å®¹ä»¥ä¾¿é‡è¯•
            state.pendingContent = content;
        }

        async function retryProcess() {
            if (state.pendingContent) {
                await processWithAI(state.pendingContent);
            }
        }

        // è‡ªç”±å¯¹è¯åŠŸèƒ½
        async function sendFreeChat() {
            const input = document.getElementById('free-chat-text');
            const message = input?.value?.trim();

            if (!message) return;

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');

            // è·å–å½“å‰ä¸Šä¸‹æ–‡
            const context = state.processedContent || state.rawContent || '';

            // åˆ¤æ–­æ˜¯å¦æ˜¯ä¿®æ”¹æ–‡ç« çš„æŒ‡ä»¤
            const isEditRequest = /ä¿®æ”¹|æ”¹ä¸€ä¸‹|æ¢|åˆ é™¤|ä¸è¦|å»æ‰|è°ƒæ•´|ç²¾ç®€|æ‰©å±•|åŠ ä¸Š|æ·»åŠ |æ”¹æˆ|é‡å†™|é‡æ–°/i.test(message);

            const progress = addProgress(isEditRequest ? 'æ­£åœ¨ä¿®æ”¹æ–‡ç« ...' : 'æ­£åœ¨æ€è€ƒ...', 'ğŸ’¬', isEditRequest ? 60 : 30);

            try {
                // è·å– API Key
                const configRes = await apiRequest('/api/config/keys');
                const configData = await configRes.json();

                if (!configData.deepseek_api_key) {
                    progress.complete('éœ€è¦é…ç½®');
                    addMessage('âŒ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® DeepSeek API Key');
                    return;
                }

                if (isEditRequest && context) {
                    // ä¿®æ”¹æ–‡ç« æ¨¡å¼ï¼šä½¿ç”¨æµå¼è¾“å‡ºé‡æ–°ç”Ÿæˆ
                    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å…¬ä¼—å·æ–‡ç« ç¼–è¾‘ã€‚ç”¨æˆ·ä¼šç»™ä½ ä¸€ç¯‡æ–‡ç« å’Œä¿®æ”¹è¦æ±‚ï¼Œè¯·æŒ‰è¦æ±‚ä¿®æ”¹æ–‡ç« å¹¶è¾“å‡ºå®Œæ•´çš„ä¿®æ”¹åæ–‡ç« ã€‚

å½“å‰æ–‡ç« ï¼š
---
${context}
---

ç”¨æˆ·çš„ä¿®æ”¹è¦æ±‚ï¼š${message}

è¯·ç›´æ¥è¾“å‡ºä¿®æ”¹åçš„å®Œæ•´æ–‡ç« ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼Œä¸è¦è§£é‡Šã€‚`;

                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${configData.deepseek_api_key}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [{ role: 'user', content: systemPrompt }],
                            max_tokens: 8000,
                            temperature: 0.7,
                            stream: true
                        })
                    });

                    if (!response.ok) throw new Error('API è°ƒç”¨å¤±è´¥');

                    // æµå¼è¯»å–å¹¶æ›´æ–°é¢„è§ˆ
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let fullContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    const delta = data.choices[0].delta.content || '';
                                    fullContent += delta;
                                    updatePreview(fullContent);
                                } catch (e) { }
                            }
                        }
                    }

                    // æ›´æ–°çŠ¶æ€
                    state.processedContent = fullContent.trim();
                    progress.complete('ä¿®æ”¹å®Œæˆ');
                    addMessage(`âœ… æ–‡ç« å·²æŒ‰è¦æ±‚ä¿®æ”¹ï¼ˆ${fullContent.replace(/\s/g, '').length} å­—ï¼‰`);

                    // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
                    setTimeout(() => showContentConfirm(state.processedContent), 500);

                } else {
                    // æ™®é€šé—®ç­”æ¨¡å¼
                    const contextHint = context ? `\n\nå½“å‰æ–‡ç« å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n${context.substring(0, 1000)}${context.length > 1000 ? '...' : ''}` : '';

                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${configData.deepseek_api_key}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                { role: 'system', content: `ä½ æ˜¯ä¸€ä¸ªå…¬ä¼—å·æ–‡ç« åŠ©æ‰‹ã€‚ç”¨æˆ·å¯èƒ½ä¼šé—®ä½ å…³äºæ–‡ç« å†…å®¹ã€æ’ç‰ˆã€å°é¢ç­‰é—®é¢˜ï¼Œè¯·ç®€æ´åœ°å›ç­”ã€‚å¦‚æœç”¨æˆ·æƒ³ä¿®æ”¹æ–‡ç« ï¼Œå‘Šè¯‰ä»–å¯ä»¥ç›´æ¥è¯´"å¸®æˆ‘ä¿®æ”¹ï¼šxxx"ã€‚${contextHint}` },
                                { role: 'user', content: message }
                            ],
                            max_tokens: 1000,
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) throw new Error('API è°ƒç”¨å¤±è´¥');

                    const data = await response.json();
                    const reply = data.choices[0].message.content;

                    progress.complete('å›å¤å®Œæˆ');
                    addMessage(reply);
                }

            } catch (e) {
                progress.complete('æ“ä½œå¤±è´¥');
                addMessage('âŒ æ“ä½œå¤±è´¥ï¼š' + (e.message || 'è¯·é‡è¯•'));
            }
        }

        function showContentConfirm(content) {
            state.processedContent = content;

            // è§£æå†…å®¹
            apiRequest('/api/parse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            }).then(r => r.json()).then(data => {
                state.title = data.title;
                state.summary = data.summary;

                addMessage(`
                    <div style="margin-bottom: 12px;">ğŸ“‹ <strong>å†…å®¹å·²å°±ç»ª</strong></div>
                    <div style="background: var(--bg-hover); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">${data.title || 'æ— æ ‡é¢˜'}</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">${data.word_count} å­—</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">ğŸ¨ <strong>é€‰æ‹©æ’ç‰ˆé£æ ¼</strong></div>
                    
                    <div class="style-grid" id="style-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="style-card" onclick="selectTheme('professional')">
                            <span class="icon">ğŸ’¼</span>
                            <span>å•†åŠ¡</span>
                        </div>
                        <div class="style-card" onclick="selectTheme('minimalist')">
                            <span class="icon">â¬œ</span>
                            <span>æç®€</span>
                        </div>
                        <div class="style-card" onclick="selectTheme('elegant')">
                            <span class="icon">ğŸ¨</span>
                            <span>ä¼˜é›…</span>
                        </div>
                        <div class="style-card" onclick="selectTheme('fresh')">
                            <span class="icon">ğŸŒ¿</span>
                            <span>æ¸…æ–°</span>
                        </div>
                        <div class="style-card" onclick="selectTheme('warm')">
                            <span class="icon">â˜€ï¸</span>
                            <span>æ¸©æš–</span>
                        </div>
                        <div class="style-card" onclick="selectTheme('wechat_official')">
                            <span class="icon">ğŸ“±</span>
                            <span>å¾®ä¿¡å®˜æ–¹</span>
                        </div>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰é£æ ¼ -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                            âœ¨ æˆ–è€…æè¿°ä½ æƒ³è¦çš„é£æ ¼ï¼ŒAI å¸®ä½ ç”Ÿæˆ
                        </div>
                        <input type="text" class="form-input" id="custom-style-input" 
                            placeholder="ä¾‹å¦‚ï¼šè«å…°è¿ªè‰²ç³»ã€insé£ã€å¤å¤æ¸¯é£ã€æ—¥ç³»æ¸…æ–°..." 
                            style="background: var(--bg-hover); margin-bottom: 8px;">
                    </div>
                    
                    <button class="submit-btn" style="width: 100%; margin-top: 12px; justify-content: center;" onclick="confirmTheme()">
                        ç¡®è®¤é£æ ¼ â†’
                    </button>
                    
                    <style>
                        .style-tag {
                            padding: 6px 14px;
                            background: var(--bg-card);
                            border: 1px solid var(--border-light);
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        .style-tag:hover, .style-tag.active {
                            background: var(--primary);
                            border-color: var(--primary);
                            color: white;
                        }
                    </style>
                `);
            });
        }

        function filterStyles(category) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.style-tag').forEach(tag => {
                tag.classList.remove('active');
                if (tag.onclick.toString().includes(category)) {
                    tag.classList.add('active');
                }
            });

            // è¿‡æ»¤é£æ ¼å¡ç‰‡
            document.querySelectorAll('.style-card').forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function selectTheme(theme) {
            state.theme = theme;
            state.customStyle = ''; // æ¸…é™¤è‡ªå®šä¹‰é£æ ¼
            document.querySelectorAll('.style-card').forEach(card => {
                card.classList.remove('selected');
                if (card.onclick.toString().includes(`'${theme}'`)) {
                    card.classList.add('selected');
                }
            });
            // æ¸…ç©ºè‡ªå®šä¹‰è¾“å…¥
            const customInput = document.getElementById('custom-style-input');
            if (customInput) customInput.value = '';
        }

        async function confirmTheme() {
            const customStyle = document.getElementById('custom-style-input')?.value?.trim();

            if (customStyle) {
                // ä½¿ç”¨è‡ªå®šä¹‰é£æ ¼
                addMessage(`è‡ªå®šä¹‰é£æ ¼ï¼š${customStyle}`, 'user');
                state.customStyle = customStyle;

                const progress = addProgress('AI æ­£åœ¨ç”Ÿæˆè‡ªå®šä¹‰é£æ ¼...', 'ğŸ¨', 20);

                try {
                    const res = await apiRequest('/api/convert-custom', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content: state.processedContent,
                            style_description: customStyle
                        })
                    });

                    const data = await res.json();
                    progress.complete('é£æ ¼ç”Ÿæˆå®Œæˆ');

                    state.htmlContent = data.html;
                    state.title = data.title;
                    state.summary = data.summary;

                    updatePreviewHTML(data.html);
                    setTimeout(() => showCoverOptions(), 500);
                } catch (e) {
                    progress.complete('ç”Ÿæˆå¤±è´¥');
                    addMessage('âŒ è‡ªå®šä¹‰é£æ ¼ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é£æ ¼');
                    state.theme = 'professional';
                    await applyTheme();
                }
            } else {
                // ä½¿ç”¨é¢„è®¾é£æ ¼
                addMessage(`å·²é€‰æ‹©ï¼š${state.theme}`, 'user');
                await applyTheme();
            }
        }

        async function applyTheme() {
            const progress = addProgress('æ­£åœ¨æ’ç‰ˆ...', 'ğŸ¨', 15);

            try {
                const res = await apiRequest('/api/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: state.processedContent,
                        theme: state.theme
                    })
                });

                const data = await res.json();
                progress.complete('æ’ç‰ˆå®Œæˆ');

                state.htmlContent = data.html;
                state.title = data.title;
                state.summary = data.summary;

                // æ›´æ–°é¢„è§ˆï¼ˆä½¿ç”¨å·²æ¸²æŸ“çš„ HTMLï¼‰
                updatePreviewHTML(data.html);

                setTimeout(() => showCoverOptions(), 500);
            } catch (e) {
                progress.complete('æ’ç‰ˆå¤±è´¥');
                addMessage(`
                    <div style="margin-bottom: 12px;">âŒ æ’ç‰ˆå¤±è´¥ï¼Œè¯·é‡è¯•</div>
                    <button class="submit-btn" style="width: 100%; justify-content: center;" onclick="applyTheme()">
                        ğŸ”„ é‡æ–°æ’ç‰ˆ
                    </button>
                `);
            }
        }

        // æ›´æ–°é¢„è§ˆï¼ˆç”¨äºæ˜¾ç¤ºå·²æ¸²æŸ“çš„ HTMLï¼Œå¦‚æ’ç‰ˆåçš„å†…å®¹ï¼‰
        function updatePreviewHTML(html) {
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = `<div class="preview-content">${html}</div>`;
        }

        function showCoverOptions() {
            addMessage(`
                <div style="margin-bottom: 12px;">ğŸ–¼ï¸ <strong>é€‰æ‹©å°é¢é£æ ¼</strong></div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">AI ä¼šæ ¹æ®æ–‡ç« å†…å®¹ç”Ÿæˆå°é¢å›¾</div>
                <div class="style-grid">
                    <div class="style-card" onclick="selectCoverStyle('auto')">
                        <span class="icon">ğŸ¤–</span>
                        <span>æ™ºèƒ½</span>
                    </div>
                    <div class="style-card" onclick="selectCoverStyle('minimalist')">
                        <span class="icon">â¬œ</span>
                        <span>æç®€</span>
                    </div>
                    <div class="style-card" onclick="selectCoverStyle('gradient')">
                        <span class="icon">ğŸŒˆ</span>
                        <span>æ¸å˜</span>
                    </div>
                    <div class="style-card" onclick="selectCoverStyle('illustration')">
                        <span class="icon">ğŸ¨</span>
                        <span>æ’ç”»</span>
                    </div>
                </div>
                <div style="margin-top: 16px;">
                    <input type="text" class="form-input" id="cover-prompt" placeholder="è‡ªå®šä¹‰æç¤ºè¯ï¼ˆå¯é€‰ï¼‰" style="background: var(--bg-hover);">
                </div>
                <button class="submit-btn" style="width: 100%; margin-top: 12px; justify-content: center;" onclick="generateCover()">
                    ç”Ÿæˆå°é¢ â†’
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="skipCover()">
                    è·³è¿‡ï¼Œä½¿ç”¨é»˜è®¤å°é¢
                </button>
            `);
        }

        function selectCoverStyle(style) {
            state.coverStyle = style;
            document.querySelectorAll('.style-card').forEach(card => {
                card.classList.remove('selected');
                if (card.onclick.toString().includes(style)) {
                    card.classList.add('selected');
                }
            });
        }

        async function generateCover() {
            const customPrompt = document.getElementById('cover-prompt')?.value || '';

            addMessage(`ç”Ÿæˆå°é¢ï¼š${state.coverStyle || 'auto'}${customPrompt ? ' - ' + customPrompt : ''}`, 'user');

            const progress = addProgress('AI æ­£åœ¨åˆ›ä½œå°é¢...', 'ğŸ¨', 45);

            try {
                const res = await apiRequest('/api/generate-cover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: state.title,
                        summary: state.summary,
                        theme: state.theme,
                        style: customPrompt || state.coverStyle
                    })
                });

                const data = await res.json();
                progress.complete('å°é¢ç”Ÿæˆå®Œæˆ');

                if (data.success) {
                    state.coverUrl = data.image_url;

                    addMessage(`
                        <div style="margin-bottom: 12px;">âœ… å°é¢å·²ç”Ÿæˆ</div>
                        <img src="${data.image_url}" style="width: 100%; border-radius: 10px; margin-bottom: 16px;">
                        <button class="submit-btn" style="width: 100%; justify-content: center;" onclick="showPublishConfirm()">
                            å‡†å¤‡å‘å¸ƒ â†’
                        </button>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="generateCover()">
                            é‡æ–°ç”Ÿæˆ
                        </button>
                    `);
                } else {
                    addMessage('âŒ å°é¢ç”Ÿæˆå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å°é¢');
                    skipCover();
                }
            } catch (e) {
                progress.complete('ç”Ÿæˆå¤±è´¥');
                addMessage(`
                    <div style="margin-bottom: 12px;">âŒ å°é¢ç”Ÿæˆå¤±è´¥</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" style="flex: 1;" onclick="skipCover()">
                            è·³è¿‡å°é¢
                        </button>
                        <button class="submit-btn" style="flex: 1; justify-content: center;" onclick="generateCover()">
                            ğŸ”„ é‡è¯•
                        </button>
                    </div>
                `);
            }
        }

        function skipCover() {
            state.coverUrl = '';
            addMessage('è·³è¿‡å°é¢', 'user');
            showPublishConfirm();
        }

        function showPublishConfirm() {
            addMessage(`
                <div style="margin-bottom: 16px;">ğŸ“¤ <strong>å‡†å¤‡å‘å¸ƒåˆ°å…¬ä¼—å·</strong></div>
                <div style="background: var(--bg-hover); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">${state.title}</div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${state.summary || 'æ— æ‘˜è¦'}</div>
                    ${state.coverUrl ? `<img src="${state.coverUrl}" style="width: 100%; border-radius: 8px; margin-top: 8px;">` : ''}
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="copyToClipboard()">
                        ğŸ“‹ å¤åˆ¶HTML
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="togglePreview()">
                        ğŸ‘ï¸ é¢„è§ˆ
                    </button>
                </div>
                <button class="submit-btn" style="width: 100%; justify-content: center; background: var(--success);" onclick="publishArticle()">
                    å‘å¸ƒåˆ°è‰ç¨¿ç®± ğŸš€
                </button>
            `);
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(state.htmlContent);
                alert('å·²å¤åˆ¶ï¼å¯ç›´æ¥ç²˜è´´åˆ°å…¬ä¼—å·ç¼–è¾‘å™¨');
            } catch (e) {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = state.htmlContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('å·²å¤åˆ¶ï¼å¯ç›´æ¥ç²˜è´´åˆ°å…¬ä¼—å·ç¼–è¾‘å™¨');
            }
        }

        async function publishArticle() {
            if (!state.configured) {
                alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®å¾®ä¿¡å…¬ä¼—å·ä¿¡æ¯');
                openSettings();
                return;
            }

            addMessage('å‘å¸ƒä¸­...', 'user');
            const progress = addProgress('æ­£åœ¨å‘å¸ƒåˆ°å…¬ä¼—å·...', 'ğŸš€', 30);

            try {
                const res = await apiRequest('/api/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: state.title,
                        content: state.htmlContent,
                        summary: state.summary,
                        cover_path: state.coverUrl
                    })
                });

                const data = await res.json();
                progress.complete(data.success ? 'å‘å¸ƒæˆåŠŸ' : 'å‘å¸ƒå¤±è´¥');

                if (data.success) {
                    addMessage(`
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‰</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">å‘å¸ƒæˆåŠŸï¼</div>
                            <div style="color: var(--text-secondary);">æ–‡ç« å·²ä¿å­˜åˆ°å…¬ä¼—å·è‰ç¨¿ç®±</div>
                        </div>
                    `);
                } else {
                    addMessage(`
                        <div style="margin-bottom: 12px;">âŒ å‘å¸ƒå¤±è´¥ï¼š${data.error}</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" style="flex: 1;" onclick="copyToClipboard()">
                                ğŸ“‹ å¤åˆ¶HTMLæ‰‹åŠ¨å‘å¸ƒ
                            </button>
                            <button class="submit-btn" style="flex: 1; justify-content: center;" onclick="publishArticle()">
                                ğŸ”„ é‡è¯•
                            </button>
                        </div>
                    `);
                }
            } catch (e) {
                progress.complete('å‘å¸ƒå¤±è´¥');
                addMessage('âŒ ç½‘ç»œé”™è¯¯');
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('content-input').value = text;
            } catch (e) {
                alert('æ— æ³•è¯»å–å‰ªè´´æ¿');
            }
        }

        function togglePreview() {
            const panel = document.getElementById('right-panel');
            panel.classList.toggle('mobile-show');
        }

        function closePreview() {
            document.getElementById('right-panel').classList.remove('mobile-show');
        }

        // ==================== è®¾ç½® ====================
        function openSettings() {
            document.getElementById('settings-modal').classList.add('show');
            loadSettings();
            loadServerIP();  // åŠ è½½æœåŠ¡å™¨IP
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        async function loadSettings() {
            try {
                const res = await apiRequest('/api/config');
                const data = await res.json();

                // æ˜¾ç¤ºå·²é…ç½®çš„çŠ¶æ€ï¼ˆè„±æ•å€¼ï¼‰ï¼Œè®©ç”¨æˆ·çŸ¥é“é…ç½®å·²ä¿å­˜
                if (data.deepseek_api_key) {
                    document.getElementById('cfg-deepseek').placeholder = data.deepseek_api_key + ' (å·²é…ç½®)';
                }
                if (data.groq_api_key) {
                    document.getElementById('cfg-groq').placeholder = data.groq_api_key + ' (å·²é…ç½®)';
                }
                if (data.poe_api_key) {
                    document.getElementById('cfg-poe').placeholder = 'å·²é…ç½®';
                }
                if (data.imgbb_api_key) {
                    document.getElementById('cfg-imgbb').placeholder = data.imgbb_api_key + ' (å·²é…ç½®)';
                }
                if (data.wechat_app_id) {
                    document.getElementById('cfg-appid').placeholder = data.wechat_app_id + ' (å·²é…ç½®)';
                }
                if (data.wechat_app_secret) {
                    document.getElementById('cfg-secret').placeholder = '*** (å·²é…ç½®)';
                }
            } catch (e) {
                console.error('Load settings error:', e);
            }
        }

        // åŠ è½½æœåŠ¡å™¨IP
        async function loadServerIP() {
            const ipDisplay = document.getElementById('server-ip-display');
            if (!ipDisplay) return;

            try {
                const res = await fetch('/api/server-ip');
                const data = await res.json();
                ipDisplay.textContent = data.success ? data.ip : 'è·å–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
            } catch (e) {
                ipDisplay.textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }

        // å¤åˆ¶æœåŠ¡å™¨IP
        async function copyServerIP() {
            const ip = document.getElementById('server-ip-display').textContent;
            if (ip && ip !== 'åŠ è½½ä¸­...' && ip !== 'è·å–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•') {
                try {
                    await navigator.clipboard.writeText(ip);
                    alert('IP å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (e) {
                    // é™çº§æ–¹æ¡ˆ
                    const input = document.createElement('input');
                    input.value = ip;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    alert('IP å·²å¤åˆ¶');
                }
            }
        }

        async function saveSettings() {
            const config = {
                deepseek_api_key: document.getElementById('cfg-deepseek').value,
                groq_api_key: document.getElementById('cfg-groq').value,
                poe_api_key: document.getElementById('cfg-poe').value,
                imgbb_api_key: document.getElementById('cfg-imgbb').value,
                wechat_app_id: document.getElementById('cfg-appid').value,
                wechat_app_secret: document.getElementById('cfg-secret').value
            };

            try {
                const res = await apiRequest('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await res.json();
                if (data.success) {
                    alert('è®¾ç½®å·²ä¿å­˜' + (state.user ? 'ï¼ˆå·²å…³è”åˆ°ä½ çš„è´¦å·ï¼‰' : ''));
                    closeSettings();
                    state.configured = true;
                    document.getElementById('settings-btn').classList.remove('warning');
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        // ==================== ç¼–è¾‘æ¨¡å¼ ====================
        function toggleEditMode() {
            const preview = document.getElementById('preview-area');
            const btn = document.getElementById('edit-toggle-btn');
            const isEditing = preview.contentEditable === 'true';

            if (isEditing) {
                // é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œä¿å­˜å†…å®¹
                preview.contentEditable = 'false';
                btn.innerHTML = 'âœï¸ ç¼–è¾‘';
                btn.style.background = '';
                btn.style.width = 'auto';
                btn.style.padding = '6px 12px';
                preview.style.border = "none";

                // ä¿å­˜ç¼–è¾‘åçš„å†…å®¹åˆ°state
                const editedContent = preview.innerText || preview.textContent;
                if (editedContent && editedContent.trim()) {
                    state.processedContent = editedContent;
                    // å¦‚æœæœ‰HTMLå†…å®¹ï¼Œä¹Ÿæ›´æ–°
                    state.htmlContent = preview.innerHTML;
                }
                addMessage('âœ… å†…å®¹å·²ä¿å­˜');
            } else {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                preview.contentEditable = 'true';
                preview.focus();
                btn.innerHTML = 'ğŸ’¾ ä¿å­˜';
                btn.style.background = 'var(--success)';
                btn.style.color = 'white';
                btn.style.width = 'auto';
                btn.style.padding = '6px 12px';
                preview.style.border = "2px solid var(--primary)";
                preview.style.borderRadius = "8px";
                addMessage('âœï¸ å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œç›´æ¥åœ¨å³ä¾§ä¿®æ”¹å†…å®¹ï¼Œå®Œæˆåç‚¹å‡»"ä¿å­˜"');
            }
        }

        // ==================== ç™»å½•å¼ºåˆ¶ ====================
        function showLoginRequired() {
            addMessage(`
                <div style="margin-bottom: 12px;">ğŸ”’ <strong>è¯·å…ˆç™»å½•</strong></div>
                <div style="color: var(--text-secondary); margin-bottom: 16px;">ç™»å½•åæ‰èƒ½ä½¿ç”¨æ–‡ç« åˆ›ä½œåŠŸèƒ½ï¼Œä½ çš„è®¾ç½®å°†è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ã€‚</div>
                <button class="submit-btn" style="width: 100%; justify-content: center;" onclick="showGoogleLogin()">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px; margin-right: 8px;">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    ä½¿ç”¨ Google ç™»å½•
                </button>
            `);
        }

        function showConfigRequired() {
            addMessage(`
                <div style="margin-bottom: 12px;">âš™ï¸ <strong>è¯·å…ˆé…ç½® API Key</strong></div>
                <div style="color: var(--text-secondary); margin-bottom: 16px;">
                    ä½¿ç”¨å‰éœ€è¦é…ç½® DeepSeek API Keyï¼ˆç”¨äº AI åˆ›ä½œï¼‰ã€‚
                    <br><br>
                    <a href="https://platform.deepseek.com/api_keys" target="_blank" style="color: var(--primary-light);">ç‚¹å‡»è¿™é‡Œå…è´¹è·å– DeepSeek API Key â†’</a>
                </div>
                <button class="submit-btn" style="width: 100%; justify-content: center;" onclick="openSettings()">
                    âš™ï¸ æ‰“å¼€è®¾ç½®
                </button>
            `);
        }

        // æ£€æŸ¥ç™»å½•å’Œé…ç½®çŠ¶æ€
        function checkAuthAndConfig() {
            if (!state.user) {
                showLoginRequired();
                return false;
            }
            if (!state.configured) {
                showConfigRequired();
                return false;
            }
            return true;
        }
    </script>

    <!-- åº•éƒ¨å¼€å‘è€…ä¿¡æ¯ -->
    <div class="footer">
        è”ç³»å¼€å‘è€…ï¼šjeveinzhai
    </div>
</body>

</html>